#!/usr/bin/env node

const { argv } = require('yargs')
const Promise = require('bluebird')

const fs = Promise.promisifyAll(require('fs-extra'))

const fetch = require('../src/fetch')
const { archivePath } = require('../src/util')
const { initDb, Page } = require('../src/db')


function init() {
  return Promise.join(
    fs.mkdirpAsync(archivePath),
    initDb()
  )
}

const command = argv._[0]
if (command) {
  switch (command) {
    case 'list':
    init()
      .then(() => Page.findAll())
      .each(page => {
        console.log(JSON.stringify(page))
      })
    break

    default:
    const url = command
    init()
      .then(() => fetch(url))
      .then(res => Page.create(res))
  }
}
